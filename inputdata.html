<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="utf-8">
    <meta http-equiv="x-ua-compatible" content="ie=edge">
    <title>Input Data Kendaraan | Prestise Provinsi Bali</title>
    <meta name="viewport" content="width=device-width, initial-scale=1">
    
    <!-- Favicon -->
    <link rel="icon" href="Bali.png" type="image/png">
    <!-- Web Font -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;500;600;700;800;900&display=swap" rel="stylesheet">
    <!-- Bootstrap CSS -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <!-- Line Awesome for Icons -->
    <link rel="stylesheet" href="https://cdn.lineicons.com/4.0/lineicons.css">
    <!-- Internal CSS -->
    <style>
        :root { --primary-color: #0d6efd; --danger-color: #dc3545; --success-color: #28a745; --gray-700: #374151; --white: #ffffff; --bg-gray: #f5f5f5; }
        body { font-family: 'Poppins', sans-serif; background-color: var(--bg-gray); }
        .navbar-area { background-color: var(--white) !important; box-shadow: 0 2px 10px rgba(0,0,0,0.1); }
        .navbar-brand img { height: 60px; width: auto; }
        .main-content { background-color: var(--bg-gray); padding: 2rem 0; min-height: calc(100vh - 200px); }
        .section-title { text-align: center; margin-bottom: 2rem; }
        .section-title h2 { font-size: 2.5rem; font-weight: 700; color: #374151; }
        .section-body { max-width: 800px; margin: 0 auto; padding: 0 15px; } 
        
        /* Style untuk Card/Form Section */
        .form-card {
            background-color: var(--white);
            border-radius: 12px;
            box-shadow: 0 4px 15px rgba(0,0,0,0.08);
            padding: 2rem;
            margin-bottom: 2rem;
            border-top: 5px solid var(--danger-color);
        }
        .form-card h4 {
            font-weight: 600;
            color: var(--gray-700);
            margin-bottom: 1.5rem;
            padding-bottom: 0.5rem;
            border-bottom: 2px solid #e9ecef;
        }
        
        .form-group { margin-bottom: 1.5rem; }
        .form-group label { 
            font-weight: 600; 
            color: var(--gray-700); 
            margin-bottom: 0.5rem; 
            display: block; 
            font-size: 14px;
            font-style: italic; 
            text-transform: uppercase; 
        }
        .form-control { 
            border: 2px solid #ced4da; 
            border-radius: 0; 
            padding: 12px 16px; 
            font-size: 14px; 
            transition: all 0.3s ease; 
        }
        .form-control:focus { 
            border-color: var(--primary-color); 
            box-shadow: 0 0 0 0.2rem rgba(13, 110, 253, 0.25); 
        }
        .btn-primary-custom { 
            background-color: var(--danger-color) !important; 
            color: var(--white) !important; 
            border: none; 
            padding: 12px 30px; 
            border-radius: 0; 
            font-weight: normal; 
            transition: all 0.3s ease; 
            cursor: pointer; 
            font-size: 16px;
            width: 100%;
        }
        .btn-primary-custom:hover { 
            background-color: #c82333 !important; 
            transform: translateY(-2px); 
            box-shadow: 0 4px 12px rgba(220, 53, 69, 0.3); 
        }
        .btn-secondary-custom { 
            background-color: #6c757d; 
            color: white; 
            border: none; 
            padding: 10px 20px; 
            border-radius: 0; 
            cursor: pointer; 
        }
        .izin-entry { 
            border: 1px solid #e0e0e0; 
            padding: 1rem; 
            margin-bottom: 1rem; 
            border-radius: 8px; 
            background-color: #f9f9f9; 
            position: relative; 
        }
        .footer { 
            background: var(--white); 
            color: var(--gray-700); 
            margin-top: 2rem; 
            padding: 2rem 0 1rem; 
            text-align: center; 
            font-size: 14px; 
        }
        .btn-delete-entry {
            position: absolute; top: 10px; right: 10px; background-color: var(--danger-color); color: var(--white); border: none; border-radius: 50%;
            width: 30px; height: 30px; display: flex; align-items: center; justify-content: center; cursor: pointer; font-size: 16px;
        }
        .btn-delete-entry:hover { background-color: #c82333; }

        /* Tambahan untuk tampilan mobile yang lebih baik */
        @media (max-width: 768px) {
            .section-title h2 { font-size: 1.8rem; }
            .form-card { padding: 1.5rem; }
            .btn-delete-entry { width: 35px; height: 35px; font-size: 18px; }
        }

        /* Style untuk notifikasi */
        .notification {
            position: fixed;
            top: 20px;
            right: 20px;
            padding: 15px 25px;
            border-radius: 8px;
            color: white;
            font-weight: 500;
            z-index: 9999;
            opacity: 0;
            transform: translateX(100%);
            transition: all 0.4s ease;
            box-shadow: 0 4px 12px rgba(0,0,0,0.15);
        }
        .notification.show {
            opacity: 1;
            transform: translateX(0);
        }
        .notification.success { background-color: var(--success-color); }
        .notification.error { background-color: var(--danger-color); }
        .notification.info { background-color: var(--primary-color); }
    </style>
</head>
<body>
    <!-- Header -->
    <header class="navbar-area">
        <div class="container">
            <nav class="navbar navbar-expand-lg">
                <a class="navbar-brand" href="index.html">
                    <img src="bali1.png" alt="Provinsi Bali">
                </a>
                <!-- Tautan Navbar di Pojok Kanan -->
                <div class="navbar-nav ms-auto">
                    <a class="nav-link" href="#" data-bs-toggle="modal" data-bs-target="#cekDataModal">
                        <i class="lni lni-search"></i> Cek Data
                    </a>
                </div>
            </nav>
        </div>
    </header>

    <div class="main-content">
        <main>
            <section class="services">
                <div class="section-body">
                    <div class="section-title">
                        <h2>Input Data Kendaraan Baru</h2>
                        <p>Masukkan data kendaraan untuk ditambahkan ke dalam sistem.</p>
                    </div>

                    <form id="inputForm">
                        <!-- Card untuk Kode Registrasi -->
                        <div class="form-card">
                            <div class="form-group">
                                <label for="kodeRegistrasi">Kode Registrasi Kendaraan *</label>
                                <input type="text" class="form-control" id="kodeRegistrasi" required readonly title="Tekan lama untuk mengedit">
                            </div>
                        </div>

                        <!-- Card untuk Data Izin -->
                        <div class="form-card">
                            <h4>Data Izin</h4>
                            <div id="izinContainer">
                                <!-- Izin akan ditambahkan di sini oleh JavaScript -->
                            </div>
                            <button type="button" class="btn-secondary-custom mb-3" onclick="addIzinEntry()"><i class="lni lni-plus"></i> Tambah Izin Lainnya</button>
                        </div>

                        <!-- Card untuk Detail Kendaraan -->
                        <div class="form-card">
                            <h4>Detail Kendaraan</h4>
                            
                            <div class="form-group"><label for="tahun">Tahun Kendaraan</label><input type="number" class="form-control" id="tahun"></div>
                            <div class="form-group"><label for="warna">Warna</label><input type="text" class="form-control" id="warna"></div>
                            <div class="form-group"><label for="kapasitasMesin">Kapasitas Mesin (cc)</label><input type="number" class="form-control" id="kapasitasMesin"></div>
                            <div class="form-group"><label for="tipeSifat">Tipe Sifat</label><input type="text" class="form-control" id="tipeSifat"></div>
                            <div class="form-group"><label for="tipeKendaraan">Tipe Kendaraan</label><input type="text" class="form-control" id="tipeKendaraan"></div>
                            <div class="form-group"><label for="model">Model</label><input type="text" class="form-control" id="model"></div>
                            <div class="form-group"><label for="jenis">Jenis</label><input type="text" class="form-control" id="jenis"></div>
                            <div class="form-group"><label for="merk">Merk</label><input type="text" class="form-control" id="merk"></div>
                            <div class="form-group"><label for="noKendaraan">No Kendaraan</label><input type="text" class="form-control" id="noKendaraan"></div>
                            <div class="form-group"><label for="noRangka">No Rangka</label><input type="text" class="form-control" id="noRangka"></div>
                            <div class="form-group"><label for="noMesin">No Mesin</label><input type="text" class="form-control" id="noMesin"></div>
                            <div class="form-group"><label for="noBpkb">No BPKB</label><input type="text" class="form-control" id="noBpkb"></div>
                            <div class="form-group"><label for="noUji">No Uji</label><input type="text" class="form-control" id="noUji"></div>
                            <div class="form-group"><label for="noLambung">No Lambung</label><input type="text" class="form-control" id="noLambung"></div>
                            <div class="form-group"><label for="fasilitas">Fasilitas</label><input type="text" class="form-control" id="fasilitas"></div>
                            <div class="form-group"><label for="dayaAngkutOrang">Daya Angkut Orang (orang)</label><input type="number" class="form-control" id="dayaAngkutOrang"></div>
                            <div class="form-group"><label for="dayaAngkutBarang">Daya Angkut Barang (kg)</label><input type="number" class="form-control" id="dayaAngkutBarang"></div>
                            <div class="form-group"><label for="namaPemilik">Nama Pemilik</label><input type="text" class="form-control" id="namaPemilik"></div>
                            <div class="form-group"><label for="alamatPemilik">Alamat Pemilik</label><input type="text" class="form-control" id="alamatPemilik"></div>
                            
                            <div class="form-group mt-4 text-center">
                                <button type="submit" class="btn-primary-custom" id="submitBtn">Simpan Data</button>
                            </div>
                        </div>
                    </form>
                </div>
            </section>
        </main>
    </div>

    <!-- Footer -->
    <footer class="footer">
        <div class="container">
            <p>&copy; 2025 DPMPTSP Provinsi Bali. All rights reserved.</p>
        </div>
    </footer>

    <!-- Modal Popup Konfirmasi Hapus Izin -->
    <div class="modal fade" id="deleteModal" tabindex="-1" aria-labelledby="deleteModalLabel" aria-hidden="true">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="deleteModalLabel">Konfirmasi Hapus Izin</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <p>Apakah Anda yakin ingin menghapus izin ini?</p>
                    <div id="deleteItemName" class="fw-bold"></div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Batal</button>
                    <button type="button" class="btn btn-danger" id="confirmDeleteBtn">Hapus</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Modal Popup Edit Kode Registrasi -->
    <div class="modal fade" id="editKodeModal" tabindex="-1" aria-labelledby="editKodeModalLabel" aria-hidden="true">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="editKodeModalLabel">Edit Kode Registrasi</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <div class="mb-3">
                        <label for="newKodeInput" class="form-label">Kode Registrasi Baru</label>
                        <input type="text" class="form-control" id="newKodeInput" placeholder="Masukkan 11 digit angka">
                    </div>
                    <div class="mb-3">
                        <label for="passwordInput" class="form-label">Password</label>
                        <input type="password" class="form-control" id="passwordInput" placeholder="Masukkan password untuk konfirmasi">
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Batal</button>
                    <button type="button" class="btn btn-primary" id="confirmEditBtn">Ubah</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Modal Popup Cek Data -->
    <div class="modal fade" id="cekDataModal" tabindex="-1" aria-labelledby="cekDataModalLabel" aria-hidden="true">
        <div class="modal-dialog modal-lg">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="cekDataModalLabel">Cek Data Kendaraan</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <div id="daftarKendaraanContainer">
                        <h6>Daftar Kendaraan Terdaftar:</h6>
                        <div id="listKendaraan" class="list-group"></div>
                    </div>
                    <div id="hasilPencarian" class="d-none">
                        <button type="button" class="btn btn-secondary mb-3" id="btnKembaliKeDaftar"><i class="lni lni-arrow-left"></i> Kembali ke Daftar</button>
                        <h6 class="mb-3">Detail Kendaraan:</h6>
                        <div class="table-responsive"><table class="table table-bordered"><tbody id="tabelHasilBody"></tbody></table></div>
                    </div>
                </div>
                <div class="modal-footer">
                    <!-- Tombol Edit dan Hapus akan muncul saat data dipilih -->
                    <button type="button" class="btn btn-warning d-none" id="btnEditData"><i class="lni lni-pencil"></i> Edit Data Ini</button>
                    <button type="button" class="btn btn-danger d-none" id="btnHapusData"><i class="lni lni-trash-can"></i> Hapus Data Ini</button>
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Tutup</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Bootstrap JS -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>

    <!-- Custom JS -->
    <script>
        document.addEventListener('DOMContentLoaded', function() {
            // --- Inisialisasi dan Setup Awal ---
            const form = document.getElementById('inputForm');
            const submitBtn = document.getElementById('submitBtn');
            const izinContainer = document.getElementById('izinContainer');
            let entryToDelete = null;
            const EDIT_PASSWORD = 'pass leong'; // Ganti password sesuai kebutuhan

            // Kunci untuk localStorage
            const DB_KEY = 'dataKendaraanDB';
            const SUFFIX_KEY = 'lastRegistrationSuffix';
            const REGISTRATION_BASE = '175922535';
            const STARTING_SUFFIX = 21;

            // Fungsi untuk menampilkan notifikasi
            function showNotification(message, type = 'info') {
                const notification = document.createElement('div');
                notification.className = `notification ${type}`;
                notification.textContent = message;
                document.body.appendChild(notification);
                setTimeout(() => notification.classList.add('show'), 100);
                setTimeout(() => {
                    notification.classList.remove('show');
                    setTimeout(() => notification.remove(), 400);
                }, 3000);
            }

            // --- Manajemen Kode Registrasi ---
            function generateKodeRegistrasi() {
                let lastSuffix = localStorage.getItem(SUFFIX_KEY);
                let currentSuffix = (lastSuffix === null) ? STARTING_SUFFIX : parseInt(lastSuffix, 10) + 1;
                if (currentSuffix > 99) currentSuffix = 1; // Reset jika sudah 99
                const formattedSuffix = currentSuffix.toString().padStart(2, '0');
                const kode = REGISTRATION_BASE + formattedSuffix;
                document.getElementById('kodeRegistrasi').value = kode;
                localStorage.setItem(SUFFIX_KEY, currentSuffix.toString());
            }

            function setupLongPress() {
                const kodeInput = document.getElementById('kodeRegistrasi');
                let pressTimer;
                function startPress() { pressTimer = setTimeout(openEditModal, 500); }
                function cancelPress() { clearTimeout(pressTimer); }
                kodeInput.addEventListener('mousedown', startPress);
                kodeInput.addEventListener('mouseup', cancelPress);
                kodeInput.addEventListener('mouseleave', cancelPress);
                kodeInput.addEventListener('touchstart', startPress, { passive: true });
                kodeInput.addEventListener('touchend', cancelPress);
            }

            function openEditModal() {
                const currentKode = document.getElementById('kodeRegistrasi').value;
                document.getElementById('newKodeInput').value = currentKode;
                document.getElementById('passwordInput').value = '';
                const modal = new bootstrap.Modal(document.getElementById('editKodeModal'));
                modal.show();
            }
            
            document.getElementById('confirmEditBtn').addEventListener('click', function() {
                const newKode = document.getElementById('newKodeInput').value.trim();
                const password = document.getElementById('passwordInput').value;
                if (password !== EDIT_PASSWORD) { alert('Password salah!'); return; }
                if (newKode.length !== 11 || !/^\d+$/.test(newKode)) { alert('Kode harus 11 digit angka!'); return; }
                document.getElementById('kodeRegistrasi').value = newKode;
                const newSuffix = parseInt(newKode.slice(-2), 10);
                localStorage.setItem(SUFFIX_KEY, newSuffix.toString());
                alert('Kode Registrasi berhasil diubah!');
                bootstrap.Modal.getInstance(document.getElementById('editKodeModal')).hide();
            });

            // --- Manajemen Izin ---
            function addIzinEntry(nama = '', terbit = '', kadaluarsa = '') {
                const entryDiv = document.createElement('div');
                entryDiv.className = 'izin-entry';
                entryDiv.innerHTML = `
                    <button type="button" class="btn-delete-entry" onclick="openDeleteModal(this.closest('.izin-entry'))"><i class="lni lni-cross"></i></button>
                    <div class="row">
                        <div class="col-md-4"><div class="form-group"><label>Nama Izin</label><input type="text" class="form-control nama-izin" value="${nama}" placeholder="e.g., Kartu Pengawas ASK Baru"></div></div>
                        <div class="col-md-2"><div class="form-group"><label>Tanggal Terbit</label><input type="date" class="form-control tanggal-terbit" value="${terbit}"></div></div>
                        <div class="col-md-2"><div class="form-group"><label>Tanggal Kadaluarsa</label><input type="date" class="form-control tanggal-kadaluarsa" value="${kadaluarsa}"></div></div>
                        <div class="col-md-4"><div class="form-group"><label>Dokumen/Foto</label><input type="file" class="form-control file-dokumen"></div></div>
                    </div>
                `;
                izinContainer.appendChild(entryDiv);
            }

            function setDefaultDates() {
                const today = new Date();
                const oneYearLater = new Date(today);
                oneYearLater.setFullYear(oneYearLater.getFullYear() + 1);
                const formatDateForInput = (date) => `${date.getFullYear()}-${String(date.getMonth() + 1).padStart(2, '0')}-${String(date.getDate()).padStart(2, '0')}`;
                const todayString = formatDateForInput(today);
                const oneYearLaterString = formatDateForInput(oneYearLater);
                document.querySelectorAll('.tanggal-terbit').forEach(input => { if (!input.value) input.value = todayString; });
                document.querySelectorAll('.tanggal-kadaluarsa').forEach(input => { if (!input.value) input.value = oneYearLaterString; });
            }

            function openDeleteModal(entryElement) {
                entryToDelete = entryElement;
                const namaIzin = entryElement.querySelector('.nama-izin').value || 'Izin ini';
                document.getElementById('deleteItemName').textContent = namaIzin;
                const modal = new bootstrap.Modal(document.getElementById('deleteModal'));
                modal.show();
            }

            document.getElementById('confirmDeleteBtn').addEventListener('click', function() {
                if (entryToDelete) {
                    entryToDelete.remove();
                    entryToDelete = null;
                }
                bootstrap.Modal.getInstance(document.getElementById('deleteModal')).hide();
            });

            // --- Manajemen Data (Simpan, Edit, Hapus) ---
            function populateForm(data) {
                // Mengisi form dengan data yang ada untuk diedit
                document.getElementById('kodeRegistrasi').value = data.detail['Kode Registrasi'];
                document.getElementById('tahun').value = data.detail['Tahun Kendaraan'] || '';
                document.getElementById('warna').value = data.detail['Warna'] || '';
                document.getElementById('kapasitasMesin').value = data.detail['Kapasitas Mesin (cc)'] || '';
                document.getElementById('tipeSifat').value = data.detail['Tipe Sifat'] || '';
                document.getElementById('tipeKendaraan').value = data.detail['Tipe Kendaraan'] || '';
                document.getElementById('model').value = data.detail['Model'] || '';
                document.getElementById('jenis').value = data.detail['Jenis'] || '';
                document.getElementById('merk').value = data.detail['Merk'] || '';
                document.getElementById('noKendaraan').value = data.detail['No Kendaraan'] || '';
                document.getElementById('noRangka').value = data.detail['No Rangka'] || '';
                document.getElementById('noMesin').value = data.detail['No Mesin'] || '';
                document.getElementById('noBpkb').value = data.detail['No BPKB'] || '';
                document.getElementById('noUji').value = data.detail['No Uji'] || '';
                document.getElementById('noLambung').value = data.detail['No Lambung'] || '';
                document.getElementById('fasilitas').value = data.detail['Fasilitas'] || '';
                document.getElementById('dayaAngkutOrang').value = data.detail['Daya Angkut Orang (orang)'] || '';
                document.getElementById('dayaAngkutBarang').value = data.detail['Daya Angkut Barang (kg)'] || '';
                document.getElementById('namaPemilik').value = data.detail['Nama Pemilik'] || '';
                document.getElementById('alamatPemilik').value = data.detail['Alamat Pemilik'] || '';

                // Mengosongkan dan mengisi ulang container izin
                izinContainer.innerHTML = '';
                if (data.izin && data.izin.length > 0) {
                    data.izin.forEach(izin => addIzinEntry(izin.nama, izin.terbit, izin.kadaluarsa));
                } else {
                    // Tambahkan izin default jika tidak ada
                    addIzinEntry('Kartu Pengawas ASK Baru');
                    addIzinEntry('Kartu KP ASK');
                    addIzinEntry('Kartu KP ASK Peremajaan');
                    addIzinEntry('QR Code Kendaraan');
                    setDefaultDates();
                }
            }

            function saveData(e) {
                e.preventDefault();
                const kodeRegistrasi = document.getElementById('kodeRegistrasi').value.trim();
                if (!kodeRegistrasi) { showNotification('Kode Registrasi wajib diisi!', 'error'); return; }
                
                const isEditMode = submitBtn.textContent === 'Update Data';
                let dataKendaraan = JSON.parse(localStorage.getItem(DB_KEY)) || {};

                if (!isEditMode && dataKendaraan[kodeRegistrasi]) {
                    showNotification('Data dengan Kode Registrasi ini sudah ada!', 'error');
                    return;
                }

                const izinEntries = document.querySelectorAll('.izin-entry');
                const izinData = [];
                izinEntries.forEach(entry => {
                    const nama = entry.querySelector('.nama-izin').value;
                    const terbit = entry.querySelector('.tanggal-terbit').value;
                    const kadaluarsa = entry.querySelector('.tanggal-kadaluarsa').value;
                    const fileInput = entry.querySelector('.file-dokumen');
                    const fileName = (fileInput.files.length > 0) ? fileInput.files[0].name : '';
                    if (nama && terbit && kadaluarsa) {
                        izinData.push({ nama, terbit, kadaluarsa, dokumen: fileName });
                    }
                });

                const detailData = {
                    'Kode Registrasi': kodeRegistrasi, 'Tahun Kendaraan': document.getElementById('tahun').value, 'Warna': document.getElementById('warna').value,
                    'Kapasitas Mesin (cc)': document.getElementById('kapasitasMesin').value, 'Tipe Sifat': document.getElementById('tipeSifat').value,
                    'Tipe Kendaraan': document.getElementById('tipeKendaraan').value, 'Model': document.getElementById('model').value, 'Jenis': document.getElementById('jenis').value,
                    'Merk': document.getElementById('merk').value, 'No Kendaraan': document.getElementById('noKendaraan').value, 'No Rangka': document.getElementById('noRangka').value,
                    'No Mesin': document.getElementById('noMesin').value, 'No BPKB': document.getElementById('noBpkb').value, 'No Uji': document.getElementById('noUji').value,
                    'No Lambung': document.getElementById('noLambung').value, 'Fasilitas': document.getElementById('fasilitas').value,
                    'Daya Angkut Orang (orang)': document.getElementById('dayaAngkutOrang').value, 'Daya Angkut Barang (kg)': document.getElementById('dayaAngkutBarang').value,
                    'Nama Pemilik': document.getElementById('namaPemilik').value, 'Alamat Pemilik': document.getElementById('alamatPemilik').value,
                    'Kesimpulan Verifikasi': 'lolos'
                };
                
                dataKendaraan[kodeRegistrasi] = { izin: izinData, detail: detailData };
                localStorage.setItem(DB_KEY, JSON.stringify(dataKendaraan));

                showNotification(isEditMode ? 'Data berhasil diperbarui!' : 'Data berhasil disimpan!', 'success');

                if (confirm(`Apakah Anda ingin melihat data yang baru saja ${isEditMode ? 'diperbarui' : 'disimpan'} di halaman Pantau?`)) {
                    window.open(`pantau.html?kode=${kodeRegistrasi}`, '_blank');
                }

                // Reset form ke mode tambah data
                form.reset();
                submitBtn.textContent = 'Simpan Data';
                generateKodeRegistrasi();
                addIzinEntry('Kartu Pengawas ASK Baru');
                addIzinEntry('Kartu KP ASK');
                addIzinEntry('Kartu KP ASK Peremajaan');
                addIzinEntry('QR Code Kendaraan');
                setDefaultDates();
            }

            form.addEventListener('submit', saveData);

            // --- Modal Cek Data ---
            const cekDataModal = document.getElementById('cekDataModal');
            cekDataModal.addEventListener('shown.bs.modal', tampilkanDaftarKendaraan);
            cekDataModal.addEventListener('hidden.bs.modal', resetModalCekData);

            function tampilkanDaftarKendaraan() {
                const dataKendaraan = JSON.parse(localStorage.getItem(DB_KEY)) || {};
                const listContainer = document.getElementById('listKendaraan');
                listContainer.innerHTML = '';
                if (Object.keys(dataKendaraan).length === 0) {
                    listContainer.innerHTML = '<p class="text-muted">Belum ada data kendaraan yang terdaftar.</p>';
                    return;
                }
                for (const kode in dataKendaraan) {
                    const detail = dataKendaraan[kode].detail;
                    const nama = detail['Nama Pemilik'] || 'Tidak ada nama';
                    const listItem = document.createElement('a');
                    listItem.href = '#';
                    listItem.className = 'list-group-item list-group-item-action';
                    listItem.innerHTML = `<div class="d-flex w-100 justify-content-between"><h6 class="mb-1">${nama}</h6><small>${kode}</small></div>`;
                    listItem.onclick = function(e) { e.preventDefault(); pilihKendaraan(kode); };
                    listContainer.appendChild(listItem);
                }
            }

            function pilihKendaraan(kode) {
                const dataKendaraan = JSON.parse(localStorage.getItem(DB_KEY)) || {};
                const data = dataKendaraan[kode];
                if (data) {
                    tampilkanHasil(data.detail, kode);
                    document.getElementById('daftarKendaraanContainer').classList.add('d-none');
                    document.getElementById('hasilPencarian').classList.remove('d-none');
                }
            }

            function tampilkanHasil(data, kode) {
                const tabelBody = document.getElementById('tabelHasilBody');
                tabelBody.innerHTML = '';
                for (const key in data) {
                    const row = tabelBody.insertRow();
                    const cell1 = row.insertCell(0); const cell2 = row.insertCell(1);
                    cell1.textContent = key; cell2.textContent = data[key];
                }
                const btnEdit = document.getElementById('btnEditData');
                const btnHapus = document.getElementById('btnHapusData');
                
                btnEdit.classList.remove('d-none');
                btnEdit.setAttribute('data-kode-edit', kode);
                
                btnHapus.classList.remove('d-none');
                btnHapus.setAttribute('data-kode-hapus', kode);
            }

            function kembaliKeDaftar() {
                document.getElementById('hasilPencarian').classList.add('d-none');
                document.getElementById('daftarKendaraanContainer').classList.remove('d-none');
            }

            function resetModalCekData() {
                document.getElementById('daftarKendaraanContainer').classList.remove('d-none');
                document.getElementById('hasilPencarian').classList.add('d-none');
                document.getElementById('tabelHasilBody').innerHTML = '';
                document.getElementById('btnEditData').classList.add('d-none');
                document.getElementById('btnHapusData').classList.add('d-none');
            }

            // Event Listener untuk tombol Edit dan Hapus di dalam modal
            document.getElementById('btnEditData').addEventListener('click', function() {
                const kode = this.getAttribute('data-kode-edit');
                const dataKendaraan = JSON.parse(localStorage.getItem(DB_KEY)) || {};
                const dataToEdit = dataKendaraan[kode];
                
                if(dataToEdit) {
                    populateForm(dataToEdit);
                    submitBtn.textContent = 'Update Data'; // Ubah teks tombol
                    bootstrap.Modal.getInstance(cekDataModal).hide();
                    window.scrollTo({ top: 0, behavior: 'smooth' });
                    showNotification('Silakan edit data yang diperlukan, lalu klik "Update Data".', 'info');
                }
            });

            document.getElementById('btnHapusData').addEventListener('click', function() {
                const kode = this.getAttribute('data-kode-hapus');
                if (!kode) { alert('Tidak ada data yang dipilih untuk dihapus.'); return; }
                if (!confirm(`Apakah Anda yakin ingin menghapus data dengan Kode Registrasi ${kode}? Tindakan ini tidak dapat dibatalkan.`)) return;
                
                let dataKendaraan = JSON.parse(localStorage.getItem(DB_KEY)) || {};
                if (dataKendaraan[kode]) {
                    delete dataKendaraan[kode];
                    localStorage.setItem(DB_KEY, JSON.stringify(dataKendaraan));
                    showNotification('Data berhasil dihapus.', 'success');
                    bootstrap.Modal.getInstance(cekDataModal).hide();
                } else {
                    showNotification('Gagal menghapus data. Data mungkin sudah dihapus.', 'error');
                }
            });
            
            document.getElementById('btnKembaliKeDaftar').addEventListener('click', kembaliKeDaftar);

            // --- Jalankan Fungsi Awal ---
            generateKodeRegistrasi();
            setupLongPress();
            addIzinEntry('Kartu Pengawas ASK Baru');
            addIzinEntry('Kartu KP ASK');
            addIzinEntry('Kartu KP ASK Peremajaan');
            addIzinEntry('QR Code Kendaraan');
            setDefaultDates();
        });
    </script>
</body>
</html>